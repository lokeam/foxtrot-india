generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EquipmentStatus {
  OPERATIONAL
  NEEDS_SERVICE
  BROKEN
  IN_REPAIR
}

enum JobStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Equipment {
  id               String           @id @default(cuid())
  serialNumber     String           @unique
  make             String
  model            String
  status           EquipmentStatus  @default(OPERATIONAL)
  engineHours      Int
  projectSite      String
  latitude         Float?
  longitude        Float?
  lastInspectionAt DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  inspections      Inspection[]
  jobs             Job[]

  @@index([status])
  @@map("equipment")
}

model Job {
  id               String        @id @default(cuid())
  equipmentId      String
  customerId       String
  customerName     String
  siteAddress      String        @default("")
  contactName      String        @default("")
  contactPhone     String        @default("")
  contactEmail     String        @default("")
  issueDescription String        @db.Text
  status           JobStatus     @default(PENDING)
  technicianId     String?
  technicianName   String?
  assignedAt       DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  equipment        Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  serviceRecord    ServiceRecord?

  @@index([status])
  @@index([technicianId])
  @@index([equipmentId])
  @@map("jobs")
}

model ServiceRecord {
  id                  String    @id @default(cuid())
  jobId               String    @unique

  beforePhotos        String[]
  beforeNotes         String?   @db.Text
  beforeEngineHours   Int
  arrivedAt           DateTime
  isCheckInComplete   Boolean   @default(false)

  afterPhotos         String[]  @default([])
  diagnosis           String?   @db.Text
  workPerformed       String?   @db.Text
  partsUsed           String?   @db.Text
  afterEngineHours    Int?
  completedAt         DateTime?
  isJobComplete       Boolean   @default(false)

  revisedAt           DateTime?
  revisionCount       Int       @default(0)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  job                 Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([arrivedAt])
  @@index([completedAt])
  @@map("service_records")
}

model Inspection {
  id            String           @id @default(cuid())
  equipmentId   String
  status        EquipmentStatus
  engineHours   Int
  notes         String?          @db.Text
  photoUrls     String[]
  inspectorName String
  latitude      Float
  longitude     Float
  timestamp     DateTime         @default(now())
  createdAt     DateTime         @default(now())

  equipment     Equipment        @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([timestamp])
  @@map("inspections")
}
